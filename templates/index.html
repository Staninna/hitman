<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if ctx.is_game_page %}{% if ctx.game_exists %}Join {{ ctx.game_name }}{% else %}Game Not Found{% endif %}{% else %}Hitman Game{% endif %}</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/main.js" defer></script>
    <link rel="stylesheet" href="https://unpkg.com/xp.css" />
    <style>
        body {
            background: url('https://www.newegg.com/insider/wp-content/uploads/windows_xp_bliss-wide.jpg') no-repeat center center fixed;
            background-size: cover;
            overflow: hidden;
        }

        .center-container {
             display: flex;
             align-items: center;
             justify-content: center;
             height: 100vh;
        }

        /* Add a simple overlay for the modals */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 5;
            display: none;
        }

        /* Hide all screens by default - only show when activated by JavaScript */
        .screen {
            display: none;
        }

        .error-message {
            color: #cc0000;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }

        .info-message {
            color: #006600;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
    </style>
    <script>
        // Pass server context to JavaScript
        window.serverContext = {{ ctx | json_encode | safe }};
    </script>
</head>

<body>
    <script src="/static/main.js"></script>

    <!-- Welcome View -->
    <div id="welcomeView" class="center-container">
        <div class="window" style="width: 400px">
            <div class="title-bar">
                <div class="title-bar-text">
                    {% if ctx.is_game_page %}
                        {% if ctx.game_exists %}
                            Join {{ ctx.game_name }}
                        {% else %}
                            Game Not Found
                        {% endif %}
                    {% else %}
                        Hitman Game
                    {% endif %}
                </div>
            </div>
            <div class="window-body">
                {% if ctx.is_game_page %}
                    {% if ctx.game_exists %}
                        <h4>Join Game: {{ ctx.game_code }}</h4>
                        <p class="info-message">This game currently has {{ ctx.player_count }} player(s).</p>
                        <p style="margin-bottom: 20px;">Enter your name to join this game, or create a new game instead.</p>
                        <div class="field-row" style="justify-content: center;">
                            <button onclick="showModal('joinGameModal')">Join This Game</button>
                            <button onclick="showModal('createGameModal')">Create New Game</button>
                        </div>
                    {% else %}
                        <h4>Game Not Found</h4>
                        <p class="error-message">The game "{{ ctx.game_code }}" could not be found.</p>
                        <p style="margin-bottom: 20px;">It may have ended or the code might be incorrect. You can create a new game or try a different code.</p>
                        <div class="field-row" style="justify-content: center;">
                            <button onclick="showModal('createGameModal')">Create New Game</button>
                            <button onclick="showModal('joinGameModal')">Try Different Code</button>
                        </div>
                    {% endif %}
                {% else %}
                    <h4>Welcome to Hitman!</h4>
                    <p style="margin-bottom: 20px;">Create a new game to become the host, or join an existing game using a code from a friend.</p>
                    <div class="field-row" style="justify-content: center;">
                        <button onclick="showModal('createGameModal')">Create New Game</button>
                        <button onclick="showModal('joinGameModal')">Join Existing Game</button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modals (hidden by default) -->
    <div id="createGameModal" class="overlay" onclick="hideModal('createGameModal', event)">
        <div class="window" style="width: 300px; margin: auto;">
            <div class="title-bar">
                <div class="title-bar-text">Create New Game</div>
            </div>
            <div class="window-body">
                <fieldset>
                    <legend>Your Details</legend>
                    <div class="field-row-stacked" style="width: 200px; margin: 0 auto;">
                        <label for="creatorName">Your Name:</label>
                        <input id="creatorName" type="text" />
                    </div>
                </fieldset>
                <section class="field-row" style="justify-content: flex-end">
                    <button onclick="hideModal('createGameModal')">Cancel</button>
                    <button onclick="createGame()">Create</button>
                </section>
            </div>
        </div>
    </div>

    <div id="joinGameModal" class="overlay" onclick="hideModal('joinGameModal', event)">
        <div class="window" style="width: 300px; margin: auto;">
            <div class="title-bar">
                <div class="title-bar-text">Join Existing Game</div>
            </div>
            <div class="window-body">
                <fieldset>
                    <legend>Game Details</legend>
                    <div class="field-row-stacked" style="width: 200px">
                        <label for="gameId">Game ID:</label>
                        <input id="gameId" type="text" value="{% if ctx.game_code %}{{ ctx.game_code }}{% endif %}" />
                    </div>
                    <div class="field-row-stacked" style="width: 200px">
                        <label for="playerName">Your Name:</label>
                        <input id="playerName" type="text" />
                    </div>
                </fieldset>
                 <section class="field-row" style="justify-content: flex-end">
                    <button onclick="hideModal('joinGameModal')">Cancel</button>
                    <button onclick="joinGame()">Join</button>
                </section>
            </div>
        </div>
    </div>

    <!-- Main Game View (hidden by default) -->
    <div id="gameView" style="display: none;">
        <div class="window" style="margin: 32px; width: 500px">
            <div class="title-bar">
                <div id="gameViewTitle" class="title-bar-text">Hitman Lobby</div>
                 <div class="title-bar-controls">
                    <button aria-label="Minimize"></button>
                    <button aria-label="Maximize"></button>
                    <button aria-label="Close" onclick="leaveGame()"></button>
                </div>
            </div>
            <div class="window-body">
                <!-- Screens will be swapped inside this container -->
                <div id="gameLobby" class="screen">
                    <h3 id="lobbyGameName" style="text-align: center;">Game Lobby</h3>
                    <fieldset>
                        <legend>Your Personal Rejoin Link</legend>
                        <p>Bookmark or save this link! If you get disconnected, you can use it to get back into the game.</p>
                        <input id="rejoinLink" type="text" readonly style="width: 100%; margin-top: 5px;"/>
                        <button id="copyRejoinLinkBtn" style="width: 100%; margin-top: 5px;">Copy Rejoin Link</button>
                    </fieldset>
                    <fieldset>
                        <legend>Invite Other Players</legend>
                        <p>Share the link or QR code below with other players to have them join your game.</p>
                        <div style="display: flex; justify-content: space-evenly; align-items: center; padding-top: 10px;">
                            <div style="text-align: center;">
                                <label>Scan Code:</label>
                                <div class="qr-container" style="background:white; padding:10px; border: 1px solid grey; margin-top: 5px;">
                                    <img id="qrCode" alt="QR Code" style="width: 110px; height: 110px;"/>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <label for="shareLink">Or Copy Link:</label>
                                <input id="shareLink" type="text" readonly style="width: 220px; margin-top: 5px;"/>
                                <button id="copyLinkBtn" style="width: 220px; margin-top: 5px;">Copy Link to Clipboard</button>
                            </div>
                        </div>
                    </fieldset>
                    <fieldset style="margin-top: 15px;">
                        <legend>Players</legend>
                        <ul id="playerList" class="tree-view"></ul>
                    </fieldset>
                    <section class="field-row" style="justify-content: flex-end">
                        <button onclick="leaveGame()">Leave</button>
                        <button id="startGameBtn" style="display: none;" onclick="startGame()">Start Game</button>
                    </section>
                </div>

                <div id="gamePlaying" class="screen">
                    <fieldset id="targetInfo">
                        <legend>Your Target</legend>
                    </fieldset>
                    <fieldset>
                        <legend>Assassination</legend>
                        <div class="field-row-stacked">
                            <label for="assassinationCode">Enter target's secret code:</label>
                            <input id="assassinationCode" type="text" />
                        </div>
                        <div class="field-row" style="justify-content: flex-end">
                            <button onclick="eliminateTarget()">Assassinate</button>
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend>Active Players</legend>
                        <ul id="gamePlayerList" class="tree-view"></ul>
                    </fieldset>
                </div>

                <div id="gameFinished" class="screen">
                    <h3 style="text-align:center;">Game Over!</h3>
                    <p id="winnerText" style="text-align:center; font-size: 1.2em; margin: 20px;"></p>
                    <section class="field-row" style="justify-content: center">
                        <button onclick="leaveGame()">Back to Main Menu</button>
                    </section>
                </div>

                <div id="deathScreen" class="screen">
                    <h3 style="text-align:center;">You've Been Eliminated!</h3>
                    <p>You can no longer participate, but you can spectate.</p>
                    <p id="killerInfo" style="text-align:center; font-weight: bold; margin-top: 10px;"></p>
                    <section class="field-row" style="justify-content: center; margin-top: 20px;">
                        <button onclick="leaveGame()">Back to Main Menu</button>
                    </section>
                </div>
            </div>
        </div>
    </div>
</body>

</html> 